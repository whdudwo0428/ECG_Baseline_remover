# Calibration Baseline Issue Summary

## 1. 문제 현상

* **증상:** 파형의 기준축이 일정한 수평선(zero-line)을 유지하지 못하고 위아래로 진동함.
* **원인:** 여러 요인이 있겠지만 대표적으로, 전극패치 장시간 부착 시 패치 부착위치가 이동될 수 있음 (하드웨어적인 문제) 이런 다양한 노이즈들이 쌓여 잡음이 포함되게 됨
* **결과:** 파형 전체가 기준선과 함께 흔들리며, 간헐적으로 진폭이 비정상적으로 커지는 구간(앰프 폭주)이 발생함.
* **환경 요인:** 패치 부착 위치의 미세 이동, 접촉면 장력 변화, 센서 신호의 드리프트 등 **하드웨어적 잡음**이 주요 원인.

---

## 2. 원인 요약

* 하드웨어 이동(gradient, volatility spike)이 발생하면
  → `calibration.py` 내부의 베이스라인 제거 알고리즘(`baseline_hybrid_plus_adaptive`)이
  → 그 노이즈를 “신호 변화”로 오인하고 **베이스라인을 과도하게 따라감**.
* 결과적으로 기준축이 고정되지 않고, 드리프트가 남음.

---

## 3. 관련 코드 위치

* **파일:** `calibration.py`
* **핵심 함수:** `baseline_hybrid_plus_adaptive(x, fs, asls_lam, vol_gain, ...)`

  * 내부 로직에서 `lam_local = asls_lam / (1 + vol_gain * z_vol)` 로 계산됨.
  * 이때 `z_vol`이 커질수록 `lam_local`이 작아져, 베이스라인이 **더 유연하게** 변형됨.
  * 즉, 노이즈가 클수록 스무딩이 약해지고 baseline이 흔들림.

---

## 4. 현재 임시 해결 방식

* 코드 내에서 다음과 같은 임시 보정이 적용 중:

  * `lam_floor_ratio`(최소 λ)로 지나치게 작은 스무딩 방지.
  * `median_filter` 기반 offset 보정(`off = median_filter(resid, size=clamp_w)`).
  * `qrs_aware` 마스크(ECG 전용)로 일부 refit 구간 제한.
* 하지만 위 방법들은 **노이즈 구간에서 λ 자체가 너무 작아지는 구조적 문제**를 해결하지 못함.

---

## 5. 목표 (정상 상태)

* 기준축이 **고정된 일자 수평선(linear zero-level baseline)** 을 중심으로
  신호가 상·하 대칭적으로 진동해야 함.
* 즉, 파형의 기준선이 시간에 따라 움직이지 않고,
  진폭 변화나 DC drift 없이 **직관적인 예시를 들자면, z-score처럼 안정된 진동 형태**를 유지해야 함.

---

## 6. 현시점 미해결 핵심

* **본질적인 문제:**

  * λ 계산식이 “노이즈 ↑ → λ ↓” 구조라,
    실제로는 “노이즈 ↑ → baseline이 따라감” 현상이 발생.
  * 드리프트·움직임을 baseline fitting에서 **배제하지 않고 포함시켜버리는 구조**.
* **따라서:** 하드웨어 잡음이 커질수록 baseline이 불안정하게 움직이며
  ‘기준축 진동’이 재현됨.

---

### problem.md 문서 분석 및 본질적 이해

problem.md 문서는 ECG (심전도) 신호 처리 과정에서 발생하는 베이스라인 (기준축) 드리프트 문제를 다루고 있습니다. 이는 의료/생체 신호 처리 분야에서 흔한 이슈로, 신호의 정확한 분석을 방해하는 노이즈 관련 문제입니다. 아래에서 문서의 내용을 구조적으로 분석하고, 본질적인 원인, 영향, 그리고 해결 방향을 이해한 바를 설명하겠습니다. 분석은 문서의 섹션별로 나누어 진행하되, 전체적인 맥락을 연결하여 요약하겠습니다.

#### 1. 문제 현상 (증상, 원인, 결과, 환경 요인)
- **증상**: ECG 파형의 기준축 (zero-line)이 고정되지 않고 위아래로 진동합니다. 이는 신호가 안정적으로 중심을 유지하지 못하는 것을 의미합니다.
- **원인**: 주로 하드웨어적 문제로, 전극 패치가 장시간 부착되어 위치가 미세하게 이동하거나, 접촉면의 장력 변화, 센서 드리프트 등이 발생합니다. 이러한 요인들이 쌓여 노이즈 (잡음)가 신호에 포함됩니다.
- **결과**: 전체 파형이 기준선과 함께 흔들리며, 간헐적으로 진폭이 비정상적으로 커지는 "앰프 폭주" (amplifier runaway) 구간이 나타납니다. 이는 신호의 신뢰성을 떨어뜨려, 예를 들어 심박수 계산이나 이상 진단에 오류를 유발할 수 있습니다.
- **환경 요인**: 패치 부착 위치의 이동, 접촉 변화 등 물리적/기계적 노이즈가 주요 원인입니다. 이는 소프트웨어 알고리즘만으로는 완벽히 해결하기 어려운 하드웨어-소프트웨어 결합 문제입니다.

**본질적 이해**: 이 섹션은 문제의 "현상적 증상"을 강조합니다. ECG 신호는 본래 생체 신호로 노이즈가 불가피하지만, 여기서는 베이스라인 드리프트가 핵심 이슈입니다. 이는 신호의 DC offset (직류 성분)이나 저주파 노이즈가 제대로 제거되지 않아 발생하는 것으로, 신호 처리의 기본 단계인 베이스라인 보정 (baseline correction)이 실패하는 사례입니다. 이미지 스크린샷을 보면 상단 파형이 진동하고 하단에 HV (High Variance) 마스크가 표시된 것으로 보아, 노이즈 구간이 명확히 시각화되어 있습니다.

#### 2. 원인 요약
- 하드웨어 이동 (gradient 변화나 volatility spike)이 발생하면, `calibration.py` 파일의 `baseline_hybrid_plus_adaptive` 함수가 이 노이즈를 "신호 변화"로 잘못 해석합니다.
- 결과적으로 베이스라인이 노이즈를 과도하게 따라가며 (over-fitting), 기준축이 고정되지 않고 드리프트가 잔존합니다.

**본질적 이해**: 문제의 뿌리는 알고리즘의 "적응성 (adaptivity)"에 있습니다. 알고리즘은 신호의 변동성을 고려해 베이스라인을 유연하게 조정하지만, 노이즈를 신호로 오인하는 취약점이 있습니다. 이는 적응형 필터링 (adaptive filtering)에서 흔한 딜레마: 과도한 유연성은 노이즈를 흡수하지만, 안정성을 잃게 됩니다. 여기서 "gradient"와 "volatility spike"는 신호의 미분(변화율)과 분산(변동성)을 가리키며, 하드웨어 노이즈가 이러한 지표를 왜곡시킵니다.

#### 3. 관련 코드 위치
- **파일**: `calibration.py`
- **핵심 함수**: `baseline_hybrid_plus_adaptive(x, fs, asls_lam, vol_gain, ...)`
  - 내부 로직: `lam_local = asls_lam / (1 + vol_gain * z_vol)`
    - `z_vol`은 신호의 변동성 (volatility)을 정규화한 값으로, 노이즈가 클수록 커집니다.
    - `z_vol` ↑ → `lam_local` ↓ → 스무딩 강도 약화 → 베이스라인이 더 유연하게 변형되어 노이즈를 따라갑니다.
- 이는 Asymmetric Least Squares (ASLS) 기반 베이스라인 제거 알고리즘의 변형으로 보입니다. ASLS는 베이스라인을 추정할 때 가중치를 동적으로 조정하지만, 여기서 λ (smoothing parameter)가 변동성에 반비례하도록 설계되어 문제가 증폭됩니다.

**본질적 이해**: 코드 수준에서 문제는 λ의 동적 계산 공식에 있습니다. λ는 스무딩의 "강도"를 결정하는데, 노이즈가 클수록 λ가 작아져 베이스라인이 "딱딱하지 않고 부드럽게" (less rigid) 변합니다. 이는 의도된 적응성ですが, 노이즈를 신호로 착각하는 부작용을 낳습니다. calibration.py 코드를 보면 이 함수가 percentile filter, gradient 계산, ASLS 등 복잡한 로직을 사용하지만, 노이즈 구분 메커니즘이 부족합니다.

#### 4. 현재 임시 해결 방식
- 코드 내 임시 보정:
  - `lam_floor_ratio`: λ의 최소값을 설정해 과도한 유연성을 방지.
  - `median_filter` 기반 offset 보정: 잔차(residual)를 메디안 필터링해 오프셋을 조정.
  - `qrs_aware` 마스크: ECG 특유의 QRS 복합파 (심박 피크)를 보호해 베이스라인 피팅 시 제외.
- 그러나 이러한 방법들은 "λ 자체가 너무 작아지는 구조적 문제"를 근본적으로 해결하지 못합니다. 즉, 증상 완화에 그칩니다.

**본질적 이해**: 임시 해결은 "안전장치" (guardrails) 수준입니다. 예를 들어 λ floor는 하한선을 두지만, 노이즈가 극심할 때 여전히 λ가 낮아집니다. QRS-aware는 ECG 도메인 지식을 활용한 좋은 접근이지만, 일반 노이즈에는 한계가 있습니다. 이는 알고리즘의 근본 설계 변경이 필요함을 시사합니다.

#### 5. 목표 (정상 상태)
- 기준축이 고정된 일자 수평선 (linear zero-level baseline)을 유지.
- 신호가 상·하 대칭적으로 진동: 예를 들어 z-score처럼 평균 0, 표준편차 1로 정규화된 안정된 형태.
- 파형의 기준선이 시간에 따라 움직이지 않으며, 진폭 변화나 DC drift 없이 유지.

**본질적 이해**: 목표는 "안정성과 대칭성"입니다. 이상적인 ECG 신호는 베이스라인이 0레벨에서 평평해야 하며, 노이즈 없이 심박 리듬만 나타나야 합니다. 이는 신호 처리의 궁극적 목적: 노이즈 제거 후 유의미한 특징 (e.g., R-peak) 추출. z-score 비유는 신호를 표준화하여 비교/분석하기 쉽게 하려는 의도입니다.

#### 6. 현시점 미해결 핵심
- **본질적인 문제**:
  - λ 계산식의 구조: 노이즈 ↑ → λ ↓ → 베이스라인이 노이즈를 따라감.
  - 드리프트나 움직임을 베이스라인 피팅에서 "배제하지 않고 포함"시킴.
- **따라서**: 하드웨어 잡음이 커질수록 베이스라인이 불안정해지며, 기준축 진동이 재현됩니다.

**본질적 이해**: 핵심은 "노이즈와 신호의 구분 실패"입니다. 알고리즘은 변동성을 신호 강도로 보지만, 실제로는 하드웨어 노이즈입니다. 이는 과적합 (overfitting) 문제로, 머신러닝 관점에서 보면 학습 데이터(신호)에 노이즈가 섞여 모델(베이스라인)이 왜곡됩니다. 해결을 위해 노이즈 모델링 (e.g., 별도 노이즈 추정 단계)이나 고정 λ 사용, 또는 AI 기반 노이즈 분류가 필요할 수 있습니다.

#### 전체적 본질적 이해와 함의
- **문제의 본질**: ECG 베이스라인 제거 알고리즘의 적응성이 역효과를 내는 "구조적 취약점". 하드웨어 노이즈를 신호 변화로 오인해 베이스라인이 드리프트되며, 이는 신호 품질 저하로 이어집니다. 이는 생체 신호 처리에서 흔한 "노이즈 vs. 신호" 딜레마의 구체적 사례입니다.
- **영향**: 임상적으로 ECG 분석 오류 (e.g., 부정맥 오진단), 연구/개발에서 데이터 신뢰성 상실. 이미지에서 보듯 HV 제거 비율 (20.38%)이 높아 유효 데이터 손실도 큽니다.
- **개선 방향 제안 (문서 기반 추론)**:
  - **알고리즘 수정**: λ 계산을 역전시키거나 (노이즈 ↑ → λ ↑), 별도 노이즈 감지 단계 추가 (e.g., wavelet 분해로 저주파 노이즈 분리).
  - **하드웨어 보완**: 패치 안정화나 다중 센서 fusion으로 노이즈 줄이기.
  - **대안 접근**: 고정 λ ASLS나 polynomial fitting, 또는 ML 기반 베이스라인 추정 (e.g., autoencoder).
  - calibration.py를 보면 QRS-aware처럼 도메인 지식을 더 활용하거나, residual refit을 강화할 수 있습니다.
